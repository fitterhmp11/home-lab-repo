---
# ============================================================================
# Playbook: checkpoint_restore.yml
#
# Purpose:
#   Restore Aruba CX running configuration from a previously saved JSON
#   checkpoint created by checkpoint_backup.yml.
#
# State Handling:
#   - Uses the "state" variable to select which checkpoint directory to restore
#   - Defaults to "latest" if no state is provided
#
# Usage Examples:
#   Restore all devices from latest:
#     ansible-playbook checkpoint_restore.yml
#
#   Restore OSPF state to all devices:
#     ansible-playbook checkpoint_restore.yml -e state=ospf
#
#   Restore only cx1 from BGP state:
#     ansible-playbook checkpoint_restore.yml -e state=bgp -l cx1
#
# Notes:
#   - Designed for Containerlab Aruba CX topology
#   - Uses REST API (pyaoscx), not SSH
#   - JSON files must exist for each target device
# ============================================================================

- name: Restore running config from a named state
  hosts: clab_nodes
  gather_facts: no
  collections:
    - arubanetworks.aoscx

  vars:
    state_name: "{{ state | default('latest') }}"

  tasks:
    - name: Check that state directory exists
      stat:
        path: "/ansible/documentation/states/clab/{{ lab_topo }}/{{ state_name }}"
      register: state_dir

    - name: Fail if state directory does not exist
      fail:
        msg: "State directory /ansible/documentation/states/clab/{{ lab_topo }}/{{ state_name }} does not exist!"
      when: not state_dir.stat.exists

    - name: Restore JSON config to device
      aoscx_upload_config:
        config_name: 'running-config'
        config_file: "{{ config_file | default('/ansible/documentation/states/clab/' ~ lab_topo ~ '/' ~ state_name ~ '/' ~ inventory_hostname ~ '.json') }}"